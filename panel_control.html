{% extends 'base.html' %}
{% block title %}Panel de Control - ProcrastinacionApp{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Hola, {{ username }}</h1>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Cerrar sesión</a>
</div>

<!-- Estadísticas resumen -->
<div class="mb-4">
    <div class="row text-center">
        <div class="col-md-4">
            <div class="card border-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total de Tareas</h5>
                    <p class="display-6">{{ tasks|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Completadas</h5>
                    <p class="display-6">{{ tasks|selectattr('completed')|list|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Pendientes</h5>
                    <p class="display-6">{{ tasks|rejectattr('completed')|list|length }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Formulario para agregar tarea -->
<h3>Agregar Tarea</h3>
<form method="POST" action="{{ url_for('add_task') }}" class="mb-3 d-flex gap-2">
    <input type="text" name="task" placeholder="Nueva tarea..." class="form-control" required />
    <button type="submit" class="btn btn-success">Agregar</button>
</form>

<!-- Filtros y búsqueda -->
<div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
        <a href="{{ url_for('panel_control', filter='all') }}" class="btn btn-outline-primary {% if filter_status == 'all' %}active{% endif %}">Todas</a>
        <a href="{{ url_for('panel_control', filter='completed') }}" class="btn btn-outline-success {% if filter_status == 'completed' %}active{% endif %}">Completadas</a>
        <a href="{{ url_for('panel_control', filter='pending') }}" class="btn btn-outline-warning {% if filter_status == 'pending' %}active{% endif %}">Pendientes</a>
        <a href="{{ url_for('panel_control', filter='important') }}" class="btn btn-outline-danger {% if filter_status == 'important' %}active{% endif %}">Importantes</a>
    </div>
    <form method="GET" action="{{ url_for('panel_control') }}" class="d-flex flex-grow-1 ms-2">
        <input type="text" name="search" class="form-control" placeholder="Buscar..." value="{{ search_query }}">
        <button type="submit" class="btn btn-outline-secondary ms-1">Buscar</button>
    </form>
</div>

<!-- Tabla tareas -->
<table class="table table-striped align-middle">
    <thead>
        <tr>
            <th>Tarea</th>
            <th>Creada</th>
            <th>Finalizada</th>
            <th>Estado</th>
            <th>Importante</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr {% if task.important %}class="table-danger"{% endif %}>
            <td>{{ task.task }}</td>
            <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at else '-' }}</td>
            <td>
                {% if task.completed and task.completed_at %}
                    {{ task.completed_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if task.completed %}
                    <span class="badge bg-success">Completada</span>
                {% else %}
                    <span class="badge bg-warning text-dark">Pendiente</span>
                {% endif %}
            </td>
            <td>
                {% if task.important %}
                    <span class="badge bg-danger">Sí</span>
                {% else %}
                    <span class="badge bg-secondary">No</span>
                {% endif %}
            </td>
            <td>
                {% if not task.completed %}
                <a href="{{ url_for('complete_task', task_id=task.id) }}" class="btn btn-sm btn-success" title="Marcar como completada">
                    <i class="bi bi-check-lg"></i>
                </a>
                {% endif %}
                <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#editTaskModal{{ task.id }}" title="Editar tarea">
                    <i class="bi bi-pencil"></i>
                </button>
                <a href="{{ url_for('toggle_important_task', task_id=task.id) }}" class="btn btn-sm btn-danger" title="Marcar/Desmarcar Importante">
                    <i class="bi bi-exclamation-circle"></i>
                </a>
                <a href="{{ url_for('delete_task', task_id=task.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('¿Seguro que quieres eliminar esta tarea?')" title="Eliminar tarea">
                    <i class="bi bi-trash"></i>
                </a>
            </td>
        </tr>

        <!-- Modal para editar tarea -->
        <div class="modal fade" id="editTaskModal{{ task.id }}" tabindex="-1" aria-labelledby="editTaskLabel{{ task.id }}" aria-hidden="true">
          <div class="modal-dialog">
            <form method="POST" action="{{ url_for('edit_task', task_id=task.id) }}">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="editTaskLabel{{ task.id }}">Editar tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    <textarea name="task" class="form-control" required>{{ task.task }}</textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                  </div>
                </div>
            </form>
          </div>
        </div>

        {% else %}
        <tr><td colspan="6" class="text-center">No hay tareas para mostrar.</td></tr>
        {% endfor %}
    </tbody>
</table>

<a href="{{ url_for('report') }}" class="btn btn-info">Ver Reporte Completo</a>

<!-- Bootstrap Icons CDN (si no lo tienes ya) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

{% endblock %}
